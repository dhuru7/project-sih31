<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Setu</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap">
    <!-- Link to the new common stylesheet -->
    <link rel="stylesheet" href="set1_style.css">
    <script src="notifications.js" defer></script>
    <script src="setu-ai.js" defer></script>

    <!-- Styles specific to index.html -->
    <style>
        body.no-scroll {
            overflow: hidden;
        }

        .fade-in {
            opacity: 0;
            transform: translateY(30px);
            transition: opacity 0.6s ease-out, transform 0.6s ease-out;
        }

        .fade-in.visible {
            opacity: 1;
            transform: translateY(0);
        }

        .complaint-card {
            background-color: var(--bg-secondary);
            border: 1px solid var(--border-light);
            box-shadow: 0 4px 16px var(--shadow-light);
            transition: all 0.3s cubic-bezier(0.4, 0.0, 0.2, 1);
            cursor: pointer;
        }

        .complaint-card:hover {
            transform: translateY(-6px);
            box-shadow: 0 10px 25px var(--shadow-medium);
            border-color: var(--accent-primary);
        }

        .complaint-card.selected {
            visibility: hidden;
        }

        .complaint-card.rated-by-user {
            border-width: 2px;
            border-color: var(--accent-secondary);
            box-shadow: 0 0 0 2px var(--accent-secondary), 0 10px 25px var(--shadow-medium);
        }

        .complaint-card.rated-by-user:hover {
            border-color: var(--accent-secondary-hover);
        }

        #modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            z-index: 100;
            opacity: 0;
            transition: opacity 0.3s ease;
            display: none;
            padding: 2rem;
        }

        #modal-overlay.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        #modal-overlay.visible {
            opacity: 1;
        }

        #modal-content-wrapper {
            position: relative;
            width: 100%;
            height: 100%;
        }

        .modal-card {
            background-color: var(--bg-secondary);
            border-radius: 1rem;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            width: 100%;
            max-width: 80vw;
            max-height: 90vh;
            display: flex;
            overflow: hidden;
            position: absolute;
            will-change: transform, opacity;
            opacity: 0;
        }

        .modal-card.visible {
            opacity: 1;
            transition: opacity 0.2s ease 0.1s;
        }

        .modal-card .card-image-container {
            display: block !important;
        }

        .modal-close-btn {
            position: absolute;
            top: 0.75rem;
            right: 0.75rem;
            background: rgba(0, 0, 0, 0.3);
            color: white;
            border-radius: 9999px;
            padding: 0.5rem;
            cursor: pointer;
            z-index: 110;
            transition: transform 0.2s ease;
        }

        .modal-close-btn:hover {
            transform: scale(1.1) rotate(90deg);
        }

        .card-details {
            margin-top: 1rem;
            overflow: visible;
        }

        .card-details-inner {
            overflow: hidden;
        }

        /* This is the specific part from index.html */
        .card-details-image-wrapper img {
            aspect-ratio: 16/9;
        }

        #image-viewer-overlay {
            opacity: 0;
            transition: opacity 0.3s ease;
            cursor: zoom-out;
        }

        #image-viewer-overlay:not(.hidden) {
            display: flex;
        }

        #image-viewer-overlay.visible {
            opacity: 1;
        }

        #image-viewer-close {
            position: absolute;
            top: 1rem;
            right: 1rem;
            width: 44px;
            height: 44px;
            line-height: 44px;
            text-align: center;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 50%;
            border: none;
            font-size: 2rem;
            color: white;
            cursor: pointer;
            transition: transform 0.2s ease;
            z-index: 121;
        }

        #image-viewer-close:hover {
            transform: scale(1.1) rotate(90deg);
        }

        #fullscreen-image {
            cursor: grab;
            touch-action: none;
            object-fit: contain;
        }

        #fullscreen-image:active {
            cursor: grabbing;
        }

        .rating-container {
            max-height: 0;
            opacity: 0;
            overflow: hidden;
            transition: all 0.5s ease-in-out;
        }

        .rating-container.expanded {
            max-height: 200px;
            opacity: 1;
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid var(--border-light);
        }

        .rating-stars button {
            transition: transform 0.2s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        .rating-stars button.selected {
            transform: scale(1.25);
        }

        .rating-stars button:hover {
            transform: scale(1.15);
        }

        .rating-feedback {
            min-height: 24px;
            transition: opacity 0.3s ease-in-out;
        }

        .notification-unread-dot {
            position: absolute;
            top: 2px;
            right: 2px;
            width: 8px;
            height: 8px;
            border-radius: 9999px;
            background-color: var(--accent-primary);
            border: 1px solid var(--bg-secondary);
        }
    </style>
</head>

<body class="antialiased pb-28 sm:pb-0">
    <nav
        class="hidden sm:flex flex-col fixed top-0 left-0 h-full bg-[var(--bg-secondary)] border-r border-[var(--border-light)] w-56 shadow-lg z-50 p-2 desktop-sidebar">
        <div class="flex-shrink-0 flex justify-center pt-2 pb-8">
            <!-- === MODIFIED: Added 'notranslate' class to logo === -->
            <a href="index.html" class="logo !text-2xl notranslate"><span
                    id="animated-name-desktop-sidebar">Setu</span></a>
        </div>
        <div class="flex-grow flex flex-col items-center justify-start space-y-2">
            <a href="index.html" title="Home" class="desktop-nav-link active" id="desktop-home-link">
                <svg class="w-7 h-7 flex-shrink-0" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                    stroke-width="1.5" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round"
                        d="M2.25 12l8.954-8.955c.44-.439 1.152-.439 1.591 0L21.75 12M4.5 9.75v10.125c0 .621.504 1.125 1.125 1.125H9.75v-4.875c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125V21h4.125c.621 0 1.125-.504 1.125-1.125V9.75M8.25 21h7.5" />
                </svg>
                <span class="desktop-nav-text">Home</span>
            </a>
            <a href="search.html" title="Search" class="desktop-nav-link" id="desktop-search-link">
                <svg class="w-7 h-7 flex-shrink-0" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                    stroke-width="1.5" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round"
                        d="M21 21l-5.197-5.197m0 0A7.5 7.5 0 105.196 5.196a7.5 7.5 0 0010.607 10.607z" />
                </svg>
                <span class="desktop-nav-text">Search</span>
            </a>
            <a href="report.html" title="Report Issue"
                class="desktop-nav-link btn-cta !text-white transform hover:!scale-105 my-2 !py-4"
                id="desktop-report-link">
                <svg class="w-8 h-8 flex-shrink-0" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                    stroke-width="2" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" />
                </svg>
                <span class="desktop-nav-text">Report</span>
            </a>
            <button id="open-filter-btn-desktop" title="Filter" class="desktop-nav-link">
                <svg class="w-7 h-7 flex-shrink-0" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                    stroke-width="1.5" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round"
                        d="M10.5 6h9.75M10.5 6a1.5 1.5 0 11-3 0m3 0a1.5 1.5 0 10-3 0M3.75 6H7.5m3 12h9.75m-9.75 0a1.5 1.5 0 01-3 0m3 0a1.5 1.5 0 00-3 0m-3.75 0H7.5m9-6h3.75m-3.75 0a1.5 1.5 0 01-3 0m3 0a1.5 1.5 0 00-3 0m-9.75 0h9.75" />
                </svg>
                <span class="desktop-nav-text">Filter</span>
            </button>
            <a href="profile.html" title="Profile" class="desktop-nav-link" id="desktop-profile-link">
                <svg class="w-7 h-7 flex-shrink-0" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                    stroke-width="1.5" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round"
                        d="M17.982 18.725A7.488 7.488 0 0012 15.75a7.488 7.488 0 00-5.982 2.975m11.963 0a9 9 0 10-11.963 0m11.963 0A8.966 8.966 0 0112 21a8.966 8.966 0 01-5.982-2.275M15 9.75a3 3 0 11-6 0 3 3 0 016 0z" />
                </svg>
                <span class="desktop-nav-text">Profile</span>
            </a>
        </div>
        <div class="flex-shrink-0 w-full flex flex-col items-center space-y-2 pb-2">
            <button id="notification-btn-desktop" title="Notifications" class="desktop-nav-link w-full relative">
                <svg class="w-7 h-7 flex-shrink-0" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                    stroke-width="1.5" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round"
                        d="M14.857 17.082a23.848 23.848 0 005.454-1.31A8.967 8.967 0 0118 9.75v-.7V9A6 6 0 006 9v.75a8.967 8.967 0 01-2.312 6.022c1.733.64 3.56 1.085 5.455 1.31m5.714 0a24.255 24.255 0 01-5.714 0m5.714 0a3 3 0 11-5.714 0" />
                </svg>
                <span class="desktop-nav-text">Notifications</span>
                <span id="notification-unread-dot-desktop"
                    class="notification-unread-dot !top-2 !right-auto left-8 hidden"></span>
            </button>
        </div>
    </nav>

    <div id="app" class="min-h-screen sm:pl-56">
        <header id="mobile-header" class="sm:hidden sticky top-0 z-40 py-2 px-2">
            <div class="nav-content-wrapper rounded-xl max-w-7xl mx-auto relative">
                <div class="flex justify-between items-center py-2 px-4">
                    <!-- === MODIFIED: Added 'notranslate' class to logo === -->
                    <a href="index.html" class="logo w-24 transition-all duration-300 notranslate"><span
                            id="animated-name-mobile">Setu</span></a>
                    <div id="mobile-header-buttons" class="flex items-center space-x-1 transition-all duration-300">
                        <button id="setu-ai-btn-mobile" title="Setu AI Assistant"
                            class="btn btn-cta !p-2 !rounded-full ai-widget-container">
                            <svg class="w-5 h-5 flex-shrink-0 text-white original-icon" viewBox="0 0 24 24"
                                fill="currentColor">
                                <path
                                    d="M12.0001 1.99219L3.45911 12.0002L12.0001 22.0082L20.5411 12.0002L12.0001 1.99219Z" />
                            </svg>
                        </button>
                        <button id="notification-btn-mobile" class="btn btn-secondary !p-2 relative"
                            title="Notifications">
                            <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                                stroke-width="1.5" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round"
                                    d="M14.857 17.082a23.848 23.848 0 005.454-1.31A8.967 8.967 0 0118 9.75v-.7V9A6 6 0 006 9v.75a8.967 8.967 0 01-2.312 6.022c1.733.64 3.56 1.085 5.455 1.31m5.714 0a24.255 24.255 0 01-5.714 0m5.714 0a3 3 0 11-5.714 0" />
                            </svg>
                            <span id="notification-unread-dot" class="notification-unread-dot hidden"></span>
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
            <div id="home-page" class="page active">
                <div id="feed-container" class="space-y-8"></div>
            </div>
        </main>

        <div id="filter-backdrop" class="fixed inset-0 bg-black bg-opacity-60 z-40 hidden"></div>
        <div id="filter-panel"
            class="fixed top-0 left-0 h-full w-80 max-w-full bg-[var(--bg-secondary)] shadow-xl z-50 transform -translate-x-full transition-transform duration-300 ease-in-out flex flex-col">
            <div class="p-4 border-b border-[var(--border-light)] flex justify-between items-center flex-shrink-0">
                <h3 class="text-lg font-semibold flex items-center text-[var(--text-primary)]">Filters</h3>
                <button id="close-filter-btn" class="text-[var(--text-muted)] hover:text-[var(--text-primary)]"><svg
                        class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                        stroke-width="2" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                    </svg></button>
            </div>
            <div class="p-4 space-y-4 flex-grow overflow-y-auto flex items-center justify-center">
                <p class="text-center text-[var(--text-muted)] p-4 bg-[var(--bg-accent)] rounded-lg">Filters will be
                    available soon.</p>
            </div>
        </div>

        <div id="notification-backdrop" class="fixed inset-0 bg-black bg-opacity-60 z-40 hidden"></div>
        <div id="notification-panel"
            class="fixed top-0 right-0 h-full w-80 max-w-full bg-[var(--bg-secondary)] shadow-xl z-50 transform translate-x-full transition-transform duration-300 ease-in-out flex flex-col">
            <div class="p-4 border-b border-[var(--border-light)] flex justify-between items-center flex-shrink-0">
                <h3 class="text-lg font-semibold flex items-center text-[var(--text-primary)]">Notifications</h3>
                <button id="close-notification-btn"
                    class="text-[var(--text-muted)] hover:text-[var(--text-primary)]"><svg class="w-6 h-6"
                        xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2"
                        stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                    </svg></button>
            </div>
            <div id="notification-content" class="flex-grow overflow-y-auto"></div>
        </div>

        <div class="fixed bottom-0 left-0 right-0 z-30 p-2 sm:hidden">
            <nav class="bottom-nav-content max-w-md mx-auto flex justify-around py-2">
                <a href="index.html" id="home-nav-link"
                    class="nav-link active flex flex-col items-center text-[var(--text-muted)] p-2 w-1/5"><svg
                        class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                        stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round"
                            d="M2.25 12l8.954-8.955c.44-.439 1.152-.439 1.591 0L21.75 12M4.5 9.75v10.125c0 .621.504 1.125 1.125 1.125H9.75v-4.875c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125V21h4.125c.621 0 1.125-.504 1.125-1.125V9.75M8.25 21h7.5" />
                    </svg><span class="text-xs font-semibold">Home</span></a>
                <a href="search.html" id="search-nav-link"
                    class="nav-link flex flex-col items-center text-[var(--text-muted)] hover:text-[var(--text-primary)] transition p-2 w-1/5"><svg
                        class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                        stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round"
                            d="M21 21l-5.197-5.197m0 0A7.5 7.5 0 105.196 5.196a7.5 7.5 0 0010.607 10.607z" />
                    </svg><span class="text-xs">Search</span></a>
                <a href="report.html" id="report-nav-link" class="flex flex-col items-center justify-center p-2 w-1/5">
                    <div
                        class="btn-cta text-white p-3.5 rounded-full transition duration-300 ease-in-out transform hover:scale-110 flex items-center justify-center shadow-lg -mt-6 border-4 border-[var(--bg-primary)]">
                        <svg class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                            stroke-width="2" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" />
                        </svg>
                    </div>
                </a>
                <button id="open-filter-btn"
                    class="nav-link flex flex-col items-center text-[var(--text-muted)] hover:text-[var(--text-primary)] transition p-2 w-1/5"><svg
                        class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                        stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round"
                            d="M10.5 6h9.75M10.5 6a1.5 1.5 0 11-3 0m3 0a1.5 1.5 0 10-3 0M3.75 6H7.5m3 12h9.75m-9.75 0a1.5 1.5 0 01-3 0m3 0a1.5 1.5 0 00-3 0m-3.75 0H7.5m9-6h3.75m-3.75 0a1.5 1.5 0 01-3 0m3 0a1.5 1.5 0 00-3 0m-9.75 0h9.75" />
                    </svg><span class="text-xs">Filter</span></button>
                <a href="profile.html" id="profile-nav-link"
                    class="nav-link flex flex-col items-center text-[var(--text-muted)] hover:text-[var(--text-primary)] transition p-2 w-1/5"><svg
                        class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                        stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round"
                            d="M17.982 18.725A7.488 7.488 0 0012 15.75a7.488 7.488 0 00-5.982 2.975m11.963 0a9 9 0 10-11.963 0m11.963 0A8.966 8.966 0 0112 21a8.966 8.966 0 01-5.982-2.275M15 9.75a3 3 0 11-6 0 3 3 0 016 0z" />
                    </svg><span class="text-xs">Profile</span></a>
            </nav>
        </div>
    </div>

    <div id="setu-ai-container-desktop" class="hidden sm:block">
        <button id="setu-ai-btn" title="Setu AI Assistant"
            class="btn btn-cta !p-4 !rounded-full shadow-lg transform hover:scale-110 transition-transform duration-200 ai-widget-container">
            <svg class="w-8 h-8 flex-shrink-0 text-white original-icon" viewBox="0 0 24 24" fill="currentColor">
                <path d="M12.0001 1.99219L3.45911 12.0002L12.0001 22.0082L20.5411 12.0002L12.0001 1.99219Z" />
            </svg>
        </button>
    </div>

    <div id="modal-overlay">
        <div id="modal-content-wrapper"></div>
    </div>

    <div id="image-viewer-overlay"
        class="fixed inset-0 z-[120] flex items-center justify-center bg-black bg-opacity-80 backdrop-filter backdrop-blur-lg hidden">
        <button id="image-viewer-close">&times;</button>
        <img id="fullscreen-image" src="" alt="Full screen complaint image"
            class="max-w-[90vw] max-h-[90vh] transition-transform duration-200">
    </div>

    <div id="ai-info-modal-overlay"
        class="fixed inset-0 bg-black bg-opacity-60 backdrop-filter backdrop-blur-sm z-[130] hidden items-center justify-center p-4">
        <div id="ai-info-modal"
            class="bg-[var(--bg-secondary)] rounded-2xl shadow-xl max-w-sm w-full p-6 text-center transform scale-95 opacity-0 transition-all duration-300 ease-out">
            <div class="mx-auto flex items-center justify-center h-16 w-16 rounded-full bg-[var(--bg-accent)] mb-4">
                <svg class="w-8 h-8 text-[var(--accent-primary)]" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M12.0001 1.99219L3.45911 12.0002L12.0001 22.0082L20.5411 12.0002L12.0001 1.99219Z" />
                </svg>
            </div>
            <h3 class="text-xl font-bold text-[var(--text-primary)] mb-2">Setu AI is Evolving!</h3>
            <p class="text-sm text-[var(--text-muted)] mb-6">
                Thank you for trying our new AI assistant! This feature is currently under active development. While it
                can perform some basic tasks, we're working hard to unlock its full potential. Stay tuned for exciting
                updates!
            </p>
            <button id="ai-info-got-it-btn" class="btn btn-primary w-full">Got it</button>
        </div>
    </div>

    <div id="google_translate_element"></div>

    <script>
        /* global google */
        let complaints = [];
        let notifications = [];

        function googleTranslateElementInit() { new google.translate.TranslateElement({ pageLanguage: 'en', includedLanguages: 'en,hi,bn,te,mr,ta,ur,gu,kn,ml,pa,or,as,ne', layout: google.translate.TranslateElement.InlineLayout.SIMPLE, autoDisplay: false }, 'google_translate_element'); }

        document.addEventListener('DOMContentLoaded', () => {
            /*
            --- NEW FEATURE: Animation Preference ---
            You can control the AI widget's animation style by setting a value in localStorage.
            This would typically be done via a toggle/button on a settings page.

            To enable the modern, dynamic glow animation, open your browser's developer
            console and run this command:
            localStorage.setItem('animationPreference', 'modern');

            To use the default, solid gradient animation (default behavior), run:
            localStorage.setItem('animationPreference', 'solid');
            */
            const statusStyles = { "Submitted": { bg: "bg-yellow-100", text: "text-yellow-800" }, "In Progress": { bg: "bg-blue-100", text: "text-blue-800" }, "Resolved": { bg: "bg-green-100", text: "text-green-800" } };
            const issueStyles = {
                "Garbage Dump": { bg: "bg-red-100", text: "text-red-800", darkBg: "dark:bg-red-900/80", darkText: "dark:text-red-200" },
                "No Dustbins": { bg: "bg-amber-100", text: "text-amber-800", darkBg: "dark:bg-amber-900/80", darkText: "dark:text-amber-200" },
                "Open Sewage": { bg: "bg-sky-100", text: "text-sky-800", darkBg: "dark:bg-sky-900/80", darkText: "dark:text-sky-200" },
                "Bad Roads": { bg: "bg-slate-200", text: "text-slate-800", darkBg: "dark:bg-slate-700/80", darkText: "dark:text-slate-200" }
            };
            const ratingFeedbacks = ["", "Terrible resolution", "Not satisfied", "It's okay", "Good resolution", "Excellent!"];
            const ratingStarColors = ['', 'text-[#f41f4e]', 'text-orange-400', 'text-yellow-400', 'text-lime-500', 'text-green-500'];

            const UI = {
                feedContainer: document.getElementById('feed-container'),
                filterPanel: document.getElementById('filter-panel'),
                filterBackdrop: document.getElementById('filter-backdrop'),
                openFilterBtn: document.getElementById('open-filter-btn'),
                openFilterBtnDesktop: document.getElementById('open-filter-btn-desktop'),
                closeFilterBtn: document.getElementById('close-filter-btn'),
                animatedNameMobile: document.getElementById('animated-name-mobile'),
                animatedNameDesktopSidebar: document.getElementById('animated-name-desktop-sidebar'),
                modalOverlay: document.getElementById('modal-overlay'), modalContentWrapper: document.getElementById('modal-content-wrapper'),
                homeNavLink: document.getElementById('home-nav-link'),
                imageViewerOverlay: document.getElementById('image-viewer-overlay'),
                imageViewerClose: document.getElementById('image-viewer-close'),
                fullscreenImage: document.getElementById('fullscreen-image'),
                mobileHeader: document.getElementById('mobile-header'),
                notificationBtnMobile: document.getElementById('notification-btn-mobile'),
                notificationBtnDesktop: document.getElementById('notification-btn-desktop'),
                notificationPanel: document.getElementById('notification-panel'),
                notificationBackdrop: document.getElementById('notification-backdrop'),
                closeNotificationBtn: document.getElementById('close-notification-btn'),
                notificationContent: document.getElementById('notification-content'),
                notificationUnreadDot: document.getElementById('notification-unread-dot'),
                notificationUnreadDotDesktop: document.getElementById('notification-unread-dot-desktop'),
                aiInfoModalOverlay: document.getElementById('ai-info-modal-overlay'),
                aiInfoModal: document.getElementById('ai-info-modal'),
                aiInfoGotItBtn: document.getElementById('ai-info-got-it-btn'),
            };
            let scrollObserver;

            let firstVisitTimestamp = localStorage.getItem('firstVisitTimestamp');
            if (!firstVisitTimestamp) {
                firstVisitTimestamp = new Date().toISOString();
                localStorage.setItem('firstVisitTimestamp', firstVisitTimestamp);
            }

            const welcomeNotificationRead = localStorage.getItem('welcomeNotificationRead') === 'true';
            const welcomeNotification = {
                id: 1,
                title: 'Welcome to Setu!',
                message: 'We\'re glad you\'re here. <a href="about.html" class="text-[var(--accent-primary)] font-semibold hover:underline">Learn more about Setu</a>.',
                timestamp: firstVisitTimestamp,
                read: welcomeNotificationRead
            };
            notifications.push(welcomeNotification);

            function saveComplaints() { localStorage.setItem('complaintsData', JSON.stringify(complaints)); }

            function loadComplaints() {
                let stored = localStorage.getItem('complaintsData');
                complaints = JSON.parse(stored || '[]');
            }

            const applyTheme = t => { const isDark = t === 'dark'; document.documentElement.setAttribute('data-theme', isDark ? 'dark' : 'light'); };
            const setupTheme = () => { const i = localStorage.getItem('theme') || (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light'); applyTheme(i); };

            const setupLogoAnimation = () => {
                const names = ['Setu', 'सेतु', 'সেতু', 'सेतू', 'સેતુ', 'ಸೇತು'];
                let currentIndex = 0;
                const logoElements = [UI.animatedNameDesktopSidebar, UI.animatedNameMobile].filter(el => el);
                if (logoElements.length === 0) return;
                setInterval(() => {
                    logoElements.forEach(el => el.classList.add('fade-out'));
                    setTimeout(() => {
                        currentIndex = (currentIndex + 1) % names.length;
                        logoElements.forEach(el => {
                            el.textContent = names[currentIndex];
                            el.classList.remove('fade-out');
                        });
                    }, 400);
                }, 4000);
            };

            const restoreLanguageDisplay = () => { const l = localStorage.getItem('selectedLanguage') || 'en'; if (l !== 'en') { document.cookie = `googtrans=/en/${l}; path=/`; } };
            const setupScrollAnimations = () => { scrollObserver = new IntersectionObserver((e) => { e.forEach(i => { if (i.isIntersecting) { i.target.classList.add('visible'); scrollObserver.unobserve(i.target); } }); }, { threshold: 0.1 }); };
            const formatTimeAgo = t => {
                const seconds = Math.floor((new Date() - new Date(t)) / 1000);
                if (seconds < 2) return 'Just now';
                if (seconds < 60) return `${seconds}s ago`;
                const minutes = Math.floor(seconds / 60);
                if (minutes < 60) return `${minutes}m ago`;
                const hours = Math.floor(minutes / 60);
                if (hours < 24) return `${hours}h ago`;
                return `${Math.floor(hours / 24)}d ago`;
            };
            const getAverageRating = r => r.length === 0 ? { avg: 0, count: 0 } : { avg: (r.reduce((a, c) => a + c, 0) / r.length).toFixed(1), count: r.length };

            const createCardContent = (c, isModal = false) => {
                const s = statusStyles[c.status];
                const i = issueStyles[c.issue] || { bg: "bg-gray-200", text: "text-gray-800", darkBg: "dark:bg-gray-700", darkText: "dark:text-gray-200" };
                let ratingSectionHtml = '';

                if (c.status === 'Resolved') {
                    const { avg, count } = getAverageRating(c.ratings);
                    const avgRatingColor = ratingStarColors[Math.round(avg)] || 'text-yellow-400';
                    const starIconSvg = `<svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" /></svg>`;
                    const actionButton = c.userRated ? `<span class="text-sm font-semibold text-[var(--accent-secondary)]">You Rated This</span>` : `<button class="rate-now-btn btn btn-secondary text-xs py-1 px-3" data-complaint-id="${c.id}">Rate Resolution</button>`;
                    let ratingStarsHtml = '';
                    for (let i = 1; i <= 5; i++) {
                        ratingStarsHtml += `<button class="rating-star p-1 text-gray-300" data-value="${i}">${starIconSvg.replace('w-4 h-4', 'w-8 h-8')}</button>`;
                    }
                    const inlineRatingForm = c.userRated ? '' : `<div class="rating-container"><p class="text-md font-semibold text-[var(--text-primary)] mb-2">How was the resolution?</p><div class="rating-stars flex justify-center items-center mb-2 space-x-2">${ratingStarsHtml}</div><p class="rating-feedback text-center text-[var(--text-muted)] text-sm mb-4"></p><div class="flex justify-end"><button class="submit-rating-btn btn btn-primary" data-complaint-id="${c.id}" disabled>Submit</button></div></div>`;
                    ratingSectionHtml = `<div class="mt-auto"><div class="pt-4 border-t border-[var(--border-light)] flex justify-between items-center"><div class="flex items-center space-x-2"><span class="${avgRatingColor}">${starIconSvg}</span><p class="text-[var(--text-primary)] font-bold text-lg">${avg}</p><p class="text-[var(--text-muted)] text-sm">(${count} votes)</p></div>${actionButton}</div>${inlineRatingForm}</div>`;
                }

                if (isModal) {
                    const imageClass = 'object-contain';
                    const imageHtml = `<div class="card-image-container w-1/2 flex-shrink-0"><img src="${c.image}" onerror="this.src='https://placehold.co/800x600/E1E2E2/1D2228?text=Image+Not+Available';" class="w-full h-full ${imageClass}"/></div>`;
                    const wrapperClasses = `main-content-wrapper flex-grow p-5 flex flex-col w-1/2 overflow-y-auto !p-8`;
                    const contentHtml = `
                         <div class="${wrapperClasses}">
                              <div class="flex items-center justify-between gap-2 mb-3">
                                  <span class="font-bold px-3 py-1 rounded-full text-xs ${i.bg} ${i.text} ${i.darkBg} ${i.darkText}">${c.issue}</span>
                                  <span class="px-3 py-1 text-xs font-bold rounded-full ${s.bg} ${s.text}">${c.status}</span>
                              </div>
                              <div class="mb-2">
                                  <p class="text-[var(--text-primary)] text-2xl font-bold"><span>${c.location}</span></p>
                                  <p class="text-sm text-[var(--text-muted)] mt-1">Submitted ${formatTimeAgo(c.timestamp)}</p>
                              </div>
                             <div class="card-details flex-grow flex flex-col">
                                 <div class="card-details-inner">
                                     <p class="text-[var(--text-secondary)] leading-relaxed my-4">${c.description}</p>
                                     <div class="border-t border-[var(--border-light)] my-4"></div>
                                     <div class="grid grid-cols-2 gap-4 text-sm">
                                        <div>
                                            <p class="font-semibold text-[var(--text-muted)] text-xs uppercase tracking-wider">Reported By</p>
                                            <p class="font-medium text-[var(--text-primary)]">${c.reporter}</p>
                                        </div>
                                        <div>
                                            <p class="font-semibold text-[var(--text-muted)] text-xs uppercase tracking-wider">Assigned To</p>
                                            <p class="font-medium text-[var(--text-primary)]">${c.authority.name}</p>
                                            <p class="text-xs text-[var(--text-muted)]">${c.authority.department}</p>
                                        </div>
                                     </div>
                                 </div>
                             </div>
                             ${ratingSectionHtml}
                         </div>`;
                    return imageHtml + contentHtml;
                }

                const desktopImageHtml = `<div class="hidden md:block md:w-1/3 lg:w-1/4 flex-shrink-0 relative card-image-container"><img src="${c.image}" onerror="this.src='https://placehold.co/400x600/E1E2E2/1D2228?text=Image+Not+Available';" class="absolute top-0 left-0 w-full h-full object-contain" alt="Complaint Image"/></div>`;
                const wrapperClasses = `main-content-wrapper flex-grow p-5 flex flex-col`;
                const contentHtml = `<div class="${wrapperClasses}"><div class="flex items-center justify-between gap-2 mb-3"><span class="font-bold px-3 py-1 rounded-full text-xs ${i.bg} ${i.text} ${i.darkBg} ${i.darkText}">${c.issue}</span><span class="px-3 py-1 text-xs font-bold rounded-full ${s.bg} ${s.text}">${c.status}</span></div><div class="mb-2"><p class="text-[var(--text-primary)] text-2xl font-bold"><span>${c.location}</span></p><p class="text-sm text-[var(--text-muted)] mt-1">Submitted ${formatTimeAgo(c.timestamp)}</p></div><div class="card-details flex-grow flex flex-col"><div class="card-details-inner"><div class="card-details-image-wrapper my-4 -mx-5 rounded-lg overflow-hidden md:hidden"><img src="${c.image}" onerror="this.src='https://placehold.co/800x400/E1E2E2/1D2228?text=Image+Not+Available';" class="w-full h-48 object-contain"/></div><p class="text-[var(--text-secondary)] leading-relaxed my-4">${c.description}</p><div class="border-t border-[var(--border-light)] my-4"></div><div class="grid grid-cols-2 gap-4 text-sm"><div><p class="font-semibold text-[var(--text-muted)] text-xs uppercase tracking-wider">Reported By</p><p class="font-medium text-[var(--text-primary)]">${c.reporter}</p></div><div><p class="font-semibold text-[var(--text-muted)] text-xs uppercase tracking-wider">Assigned To</p><p class="font-medium text-[var(--text-primary)]">${c.authority.name}</p><p class="text-xs text-[var(--text-muted)]">${c.authority.department}</p></div></div></div></div>${ratingSectionHtml}</div>`;
                return desktopImageHtml + contentHtml;
            };

            const createPostElement = c => {
                const post = document.createElement('div');
                post.className = `complaint-card rounded-2xl overflow-hidden md:flex md:flex-row fade-in ${c.userRated ? 'rated-by-user' : ''}`;
                post.dataset.complaintId = c.id;
                post.innerHTML = createCardContent(c, false);
                scrollObserver.observe(post);
                return post;
            };

            const renderFeed = cList => {
                UI.feedContainer.innerHTML = '';
                if (!cList || cList.length === 0) {
                    UI.feedContainer.innerHTML = `<div class="text-center py-16 px-6 bg-[var(--bg-secondary)] rounded-2xl shadow-sm fade-in visible col-span-1 md:col-span-2 lg:col-span-3"><svg class="mx-auto h-12 w-12 text-[var(--text-muted)]" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M11.25 11.25l.041-.02a.75.75 0 011.063.852l-.708 2.836a.75.75 0 001.063.853l.041-.021M21 12a9 9 0 11-18 0 9 9 0 0118 0zm-9-3.75h.008v.008H12V8.25z" /></svg><h3 class="mt-4 text-lg font-semibold text-[var(--text-primary)]">No Reports Found</h3><p class="mt-1 text-sm text-[var(--text-muted)]">It looks like there are no reports in your area yet.</p><div class="mt-6"><a href="report.html" class="btn btn-primary"><svg class="-ml-1 mr-2 h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M10.75 4.75a.75.75 0 00-1.5 0v4.5h-4.5a.75.75 0 000 1.5h4.5v4.5a.75.75 0 001.5 0v-4.5h4.5a.75.75 0 000-1.5h-4.5v-4.5z" /></svg>Create the First Report</a></div></div>`;
                } else {
                    cList.sort((a, b) => new Date(b.timestamp) - new Date(a, b)).forEach(c => UI.feedContainer.appendChild(createPostElement(c)));
                }
            };

            const openFilter = () => { UI.filterBackdrop.classList.remove('hidden'); UI.filterPanel.classList.remove('-translate-x-full'); };
            const closeFilter = () => { UI.filterBackdrop.classList.add('hidden'); UI.filterPanel.classList.add('-translate-x-full'); };
            const isDesktop = () => window.innerWidth >= 640;

            const handleCardClick = (e) => {
                const card = e.target.closest('.complaint-card');
                if (!card || e.target.closest('button, a, .card-image-container, .card-details-image-wrapper')) return;
                if (isDesktop()) openModal(card);
            };

            const openModal = (card) => {
                const complaintId = parseInt(card.dataset.complaintId);
                const complaint = complaints.find(c => c.id === complaintId);
                if (!complaint) return;

                const cardRect = card.getBoundingClientRect();
                card.classList.add('selected');

                const modal = document.createElement('div');
                modal.className = 'modal-card';
                modal.dataset.complaintId = complaintId;
                modal.innerHTML = createCardContent(complaint, true) + `<button class="modal-close-btn"><svg class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg></button>`;

                UI.modalContentWrapper.innerHTML = '';
                UI.modalContentWrapper.appendChild(modal);
                UI.modalOverlay.classList.add('active');

                const finalRect = modal.getBoundingClientRect();
                const dx = cardRect.left - finalRect.left;
                const dy = cardRect.top - finalRect.top;
                const dw = cardRect.width / finalRect.width;
                const dh = cardRect.height / finalRect.height;

                modal.style.transform = `translate(${dx}px, ${dy}px) scale(${dw}, ${dh})`;
                modal.style.transformOrigin = 'top left';

                requestAnimationFrame(() => {
                    UI.modalOverlay.classList.add('visible');
                    modal.style.transition = 'transform 0.35s cubic-bezier(0.4, 0, 0.2, 1)';
                    modal.style.transform = 'none';
                    modal.classList.add('visible');
                });
                modal.querySelector('.modal-close-btn').addEventListener('click', () => closeModal(card, modal));
                UI.modalOverlay.addEventListener('click', (e) => { if (e.target === UI.modalOverlay) closeModal(card, modal) });
            };

            const closeModal = (originalCard, modalCard) => {
                if (!originalCard) return;
                const cardRect = originalCard.getBoundingClientRect();
                const finalRect = modalCard.getBoundingClientRect();
                const dx = cardRect.left - finalRect.left;
                const dy = cardRect.top - finalRect.top;
                const dw = cardRect.width / finalRect.width;
                const dh = cardRect.height / finalRect.height;

                modalCard.style.transition = 'transform 0.35s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.3s ease';

                requestAnimationFrame(() => {
                    UI.modalOverlay.classList.remove('visible');
                    modalCard.style.opacity = '0';
                    modalCard.style.transform = `translate(${dx}px, ${dy}px) scale(${dw}, ${dh})`;
                });

                setTimeout(() => {
                    UI.modalOverlay.classList.remove('active');
                    UI.modalContentWrapper.innerHTML = '';
                    originalCard.classList.remove('selected');
                }, 350);
            };

            let isPanning = false, startX, startY, transformX = 0, transformY = 0, scale = 1;
            const openImageViewer = (src) => {
                UI.fullscreenImage.src = src;
                UI.imageViewerOverlay.classList.remove('hidden');
                scale = 1; transformX = 0; transformY = 0;
                UI.fullscreenImage.style.transform = `translate(${transformX}px, ${transformY}px) scale(${scale})`;
                setTimeout(() => UI.imageViewerOverlay.classList.add('visible'), 10);
            };
            const closeImageViewer = () => {
                UI.imageViewerOverlay.classList.remove('visible');
                setTimeout(() => { UI.imageViewerOverlay.classList.add('hidden'); UI.fullscreenImage.src = ''; }, 300);
            };
            const handleWheel = (e) => { e.preventDefault(); const scaleAmount = 0.1; scale += e.deltaY > 0 ? -scaleAmount : scaleAmount; scale = Math.min(Math.max(0.5, scale), 4); UI.fullscreenImage.style.transform = `translate(${transformX}px, ${transformY}px) scale(${scale})`; };
            const handlePointerDown = (e) => { isPanning = true; startX = e.clientX - transformX; startY = e.clientY - transformY; UI.fullscreenImage.style.cursor = 'grabbing'; };
            const handlePointerMove = (e) => { if (!isPanning) return; e.preventDefault(); transformX = e.clientX - startX; transformY = e.clientY - startY; UI.fullscreenImage.style.transform = `translate(${transformX}px, ${transformY}px) scale(${scale})`; };
            const handlePointerUp = () => { isPanning = false; UI.fullscreenImage.style.cursor = 'grab'; };

            const handleInteractiveElements = (e) => {
                const parent = e.target.closest('.complaint-card, .modal-card');
                const imageContainer = e.target.closest('.card-image-container, .card-details-image-wrapper');
                if (imageContainer) {
                    e.stopPropagation();
                    const image = imageContainer.querySelector('img');
                    if (image && image.src) openImageViewer(image.src);
                    return;
                }
                if (!parent) return;
                const rateNowBtn = e.target.closest('.rate-now-btn');
                if (rateNowBtn) {
                    e.stopPropagation();
                    const ratingContainer = parent.querySelector('.rating-container');
                    if (ratingContainer) ratingContainer.classList.toggle('expanded');
                    return;
                }
                const ratingStar = e.target.closest('.rating-star');
                if (ratingStar) {
                    e.stopPropagation();
                    const stars = parent.querySelectorAll('.rating-star');
                    const feedbackEl = parent.querySelector('.rating-feedback');
                    const submitBtn = parent.querySelector('.submit-rating-btn');
                    const ratingValue = parseInt(ratingStar.dataset.value);
                    const selectedColor = ratingStarColors[ratingValue];
                    feedbackEl.textContent = ratingFeedbacks[ratingValue];
                    stars.forEach(star => {
                        const starValue = parseInt(star.dataset.value);
                        star.classList.remove(...ratingStarColors.filter(c => c), 'text-gray-300', 'selected');
                        star.classList.add(starValue <= ratingValue ? selectedColor : 'text-gray-300');
                        if (starValue === ratingValue) star.classList.add('selected');
                    });
                    submitBtn.disabled = false;
                    submitBtn.dataset.rating = ratingValue;
                    return;
                }
                const submitRatingBtn = e.target.closest('.submit-rating-btn');
                if (submitRatingBtn) {
                    e.stopPropagation();
                    const complaintId = parseInt(submitRatingBtn.dataset.complaintId);
                    const selectedRating = parseInt(submitRatingBtn.dataset.rating);
                    const complaint = complaints.find(c => c.id === complaintId);
                    if (complaint && selectedRating > 0) {
                        complaint.ratings.push(selectedRating);
                        complaint.userRated = true;
                        saveComplaints();
                        renderFeed(complaints);
                        if (parent.classList.contains('modal-card')) {
                            const originalCard = UI.feedContainer.querySelector(`.complaint-card[data-complaint-id="${complaintId}"]`);
                            if (originalCard) closeModal(originalCard, parent);
                        }
                    }
                    return;
                }
            };

            Notifications.init(); /* const openNotificationPanel = () => {
                UI.notificationBackdrop.classList.remove('hidden');
                UI.notificationPanel.classList.remove('translate-x-full');
                if (!welcomeNotification.read) {
                    welcomeNotification.read = true;
                    localStorage.setItem('welcomeNotificationRead', 'true');
                    renderNotifications();
                }
            };
            const closeNotificationPanel = () => { UI.notificationBackdrop.classList.add('hidden'); UI.notificationPanel.classList.add('translate-x-full'); };

            const renderNotifications = () => {
                const hasUnread = notifications.some(n => !n.read);
                UI.notificationUnreadDot.classList.toggle('hidden', !hasUnread);
                if (UI.notificationUnreadDotDesktop) UI.notificationUnreadDotDesktop.classList.toggle('hidden', !hasUnread);
                if (notifications.length === 0) {
                    UI.notificationContent.innerHTML = `<p class="text-center text-[var(--text-muted)] p-8">You have no new notifications.</p>`;
                    return;
                }
                UI.notificationContent.innerHTML = notifications.map(n => `<div class="p-4 border-b border-[var(--border-light)] flex items-start space-x-3 ${!n.read ? '' : 'opacity-70'}">${!n.read ? '<div class="w-2 h-2 rounded-full bg-[#f41f4e] mt-2 flex-shrink-0"></div>' : '<div class="w-2 h-2 flex-shrink-0"></div>'}<div class="flex-grow"><p class="font-semibold text-[var(--text-primary)]">${n.title}</p><p class="text-sm text-[var(--text-secondary)]">${n.message}</p><p class="text-xs text-[var(--text-muted)] mt-1">${formatTimeAgo(n.timestamp)}</p></div></div>`).join('');
            }; */
            /*          UI.notificationBackdrop.classList.remove('hidden');
                        UI.notificationPanel.classList.remove('translate-x-full');
                        if (!welcomeNotification.read) {
                            welcomeNotification.read = true;
                            localStorage.setItem('welcomeNotificationRead', 'true');
                            renderNotifications();
                        }
                    }; */


            /*      const renderNotifications = () => {
                        const hasUnread = notifications.some(n => !n.read);
                        UI.notificationUnreadDot.classList.toggle('hidden', !hasUnread);
                        if (UI.notificationUnreadDotDesktop) UI.notificationUnreadDotDesktop.classList.toggle('hidden', !hasUnread);
                        if (notifications.length === 0) {
                            UI.notificationContent.innerHTML = `<p class="text-center text-[var(--text-muted)] p-8">You have no new notifications.</p>`;
                            return;
                        }
                        UI.notificationContent.innerHTML = notifications.map(n => `<div class="p-4 border-b border-[var(--border-light)] flex items-start space-x-3 ${!n.read ? '' : 'opacity-70'}">${!n.read ? '<div class="w-2 h-2 rounded-full bg-[#f41f4e] mt-2 flex-shrink-0"></div>' : '<div class="w-2 h-2 flex-shrink-0"></div>'}<div class="flex-grow"><p class="font-semibold text-[var(--text-primary)]">${n.title}</p><p class="text-sm text-[var(--text-secondary)]">${n.message}</p><p class="text-xs text-[var(--text-muted)] mt-1">${formatTimeAgo(n.timestamp)}</p></div></div>`).join('');
                    }; */

            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            let recognition;
            let currentHighlight = null;
            let isAiActive = false;
            let aiTimeout;
            let aiWidgetDesktop, aiWidgetMobile;

            // --- Setu AI Logic ---


            function generatePageSummary() {
                const summaryPoints = [];
                const cards = document.querySelectorAll('#feed-container .complaint-card');
                if (cards.length === 0) { return ["There are no issues on the page to summarize."]; }
                cards.forEach(card => {
                    const issueEl = card.querySelector('.flex.items-center.justify-between span:first-child');
                    const statusEl = card.querySelector('.flex.items-center.justify-between span:last-child');
                    const locationEl = card.querySelector('.text-\\[var\\(--text-primary\\)\\].text-2xl.font-bold span');
                    if (issueEl && locationEl && statusEl) {
                        summaryPoints.push(`'${issueEl.textContent.trim()}' at '${locationEl.textContent.trim()}' is marked as '${statusEl.textContent.trim()}'.`);
                    }
                });
                return summaryPoints.length > 0 ? summaryPoints : ["Could not find any issues to summarize on the page."];
            }

            SetuAI.init({
                onSummarize: generatePageSummary,
                onNavigate: (targetId) => {
                    if (targetId === 'filter') openFilter();
                    else {
                        const el = document.getElementById(targetId);
                        if (el && el.href) window.location.href = el.href;
                        else if (el) el.click();
                    }
                }
            });

            // Expose for AI
            window.openFilter = openFilter;

            /* Old AI Logic
            function generatePageSummary() {
                const summaryPoints = [];
                const cards = document.querySelectorAll('#feed-container .complaint-card');
                if (cards.length === 0) {
                    return ["There are no issues on the page to summarize."];
                }
                cards.forEach(card => {
                    const issueEl = card.querySelector('.flex.items-center.justify-between span:first-child');
                    const statusEl = card.querySelector('.flex.items-center.justify-between span:last-child');
                    const locationEl = card.querySelector('.text-\\[var\\(--text-primary\\)\\].text-2xl.font-bold span');
    
                    if (issueEl && locationEl && statusEl) {
                        const issue = issueEl.textContent.trim();
                        const location = locationEl.textContent.trim();
                        const status = statusEl.textContent.trim();
                        summaryPoints.push(`'${issue}' at '${location}' is marked as '${status}'.`);
                    }
                });
                return summaryPoints.length > 0 ? summaryPoints : ["Could not find any issues to summarize on the page."];
            }
    
            function displaySummary(summaryPoints) {
                // Remove existing summary box if any to prevent duplicates
                const existingBox = document.querySelector('#ai-summary-box');
                if (existingBox) existingBox.remove();
    
                const summaryBox = document.createElement('div');
                summaryBox.id = 'ai-summary-box';
                summaryBox.className = 'ai-summary-box';
    
                const title = document.createElement('h4');
                title.className = 'summary-title';
                title.textContent = 'Page Summary';
                summaryBox.appendChild(title);
    
                const list = document.createElement('ul');
                summaryPoints.forEach(point => {
                    const li = document.createElement('li');
                    li.textContent = point;
                    list.appendChild(li);
                });
                summaryBox.appendChild(list);
    
                const activeWidget = document.querySelector('.ai-widget-container.active');
                if (activeWidget) {
                    activeWidget.appendChild(summaryBox);
                    requestAnimationFrame(() => {
                        summaryBox.classList.add('visible');
                    });
                }
            }
            // --- END: AI Summary Functions ---
    
            function setupAiWidgets() {
                aiWidgetDesktop = new AiWidget(document.querySelector('#setu-ai-btn'));
                aiWidgetMobile = new AiWidget(document.querySelector('#setu-ai-btn-mobile'), true);
                if (!sessionStorage.getItem('setuAiButtonClicked')) {
                    document.querySelectorAll('.ai-widget-container').forEach(el => el.classList.add('setu-btn-animated'));
                }
                setupAiButtonSpin();
            }
    
            function setupAiButtonSpin() {
                setInterval(() => {
                    document.querySelectorAll('.ai-widget-container:not(.active) .original-icon').forEach(icon => {
                        if (icon) {
                            icon.classList.add('spin');
                            icon.addEventListener('animationend', () => {
                                icon.classList.remove('spin');
                            }, { once: true });
                        }
                    });
                }, 7000);
            }
    
            function getCurrentLanguage() {
                const cookieValue = document.cookie.split('; ').find(row => row.startsWith('googtrans='));
                if (cookieValue) {
                    const langCode = cookieValue.split('/')[2];
                    const langMap = { 'hi': 'hi-IN', 'bn': 'bn-IN', 'te': 'te-IN', 'mr': 'mr-IN', 'ta': 'ta-IN', 'ur': 'ur-IN', 'gu': 'gu-IN', 'kn': 'kn-IN', 'ml': 'ml-IN' };
                    return langMap[langCode] || 'en-US';
                }
                return 'en-US';
            }
    
            if (SpeechRecognition) {
                recognition = new SpeechRecognition();
                recognition.continuous = false;
                recognition.interimResults = true;
                recognition.maxAlternatives = 1;
                recognition.onresult = (event) => {
                    const transcript = Array.from(event.results).map(r => r[0].transcript).join('');
                    [aiWidgetDesktop, aiWidgetMobile].forEach(w => w.setStatus(`"${transcript}"`));
                    if (event.results[0].isFinal) {
                        [aiWidgetDesktop, aiWidgetMobile].forEach(w => w.setState('idle'));
                        querySarvamAI(transcript);
                    }
                };
                recognition.onerror = (event) => {
                    const errorMsg = event.error === 'no-speech' ? "I didn't hear that." : "Mic error.";
                    [aiWidgetDesktop, aiWidgetMobile].forEach(w => w.setStatus(errorMsg, true));
                };
                recognition.onend = () => { [aiWidgetDesktop, aiWidgetMobile].forEach(w => w.setState('idle')); };
            }
    
            function startListening(event) {
                if (event) event.stopPropagation();
                if (!isAiActive || !SpeechRecognition) return;
                recognition.lang = getCurrentLanguage();
                recognition.start();
                [aiWidgetDesktop, aiWidgetMobile].forEach(w => w.setState('listening'));
            }
    
            async function querySarvamAI(text) {
                [aiWidgetDesktop, aiWidgetMobile].forEach(w => w.setStatus('Thinking...'));
                try {
                    const mockAI = (query, lang) => {
                        query = query.toLowerCase();
                        let responseText = { 'en-US': "Sorry, I'm not sure how to help.", 'hi-IN': "क्षमा करें, मुझे यकीन नहीं है कि इसमें कैसे मदद की जाए।" };
                        let result = { action: 'answer', targetId: null, responseText: responseText[lang] || responseText['en-US'] };
    
                        // IMPROVEMENT: Added new AI responses
                        if (query.includes('hello') || query.includes('hi') || query.includes('hey') || query.includes('नमस्ते') || query.includes('हाय')) {
                            responseText = { 'en-US': 'Hello! How can I help you today?', 'hi-IN': 'नमस्ते! मैं आपकी कैसे मदद कर सकता हूँ?' };
                            result = { action: 'answer', targetId: null, responseText: responseText[lang] || responseText['en-US'] };
                        } else if (query.includes('who are you') || query.includes('what are you') || query.includes('what is setu') || query.includes('आप कौन हैं')) {
                            responseText = { 'en-US': 'I am Setu AI, your smart assistant to make reporting civic issues seamless and effective. How can I assist?', 'hi-IN': 'मैं सेतु एआई हूं, नागरिक मुद्दों की रिपोर्टिंग को सहज और प्रभावी बनाने के लिए आपका स्मार्ट सहायक। मैं कैसे सहायता कर सकता हूं?' };
                            result = { action: 'answer', targetId: null, responseText: responseText[lang] || responseText['en-US'] };
                        } else if (query.includes('language') || query.includes('theme') || query.includes('setting') || query.includes('profile') || query.includes('भाषा') || query.includes('थीम')) {
                            responseText = { 'en-US': 'Sure, heading to your profile and settings page.', 'hi-IN': 'ज़रूर, आपके प्रोफ़ाइल और सेटिंग्स पृष्ठ पर जा रहे हैं।' };
                            result = { action: 'redirect', targetId: 'profile.html', responseText: responseText[lang] || responseText['en-US'] };
                        } else if (query.includes('how to report') || query.includes('कैसे रिपोर्ट')) {
                            responseText = { 'en-US': 'To report an issue, please click the big red "Report" button.', 'hi-IN': 'समस्या की रिपोर्ट करने के लिए, कृपया बड़े लाल "रिपोर्ट" बटन पर क्लिक करें।' };
                            result = { action: 'answer', targetId: null, responseText: responseText[lang] || responseText['en-US'] };
                        } else if (query.includes('report') || query.includes('complaint') || query.includes('रिपोर्ट') || query.includes('शिकायत')) {
                            responseText = { 'en-US': 'Here is the report button.', 'hi-IN': 'यह रिपोर्ट बटन है।' };
                            result = { action: 'highlight', targetId: isDesktop() ? 'desktop-report-link' : 'report-nav-link', responseText: responseText[lang] || responseText['en-US'] };
                        } else if (query.includes('summarise') || query.includes('summarize') || query.includes('summary')) {
                            responseText = { 'en-US': 'Certainly. Here is a summary of the issues on this page.', 'hi-IN': 'ज़रूर। इस पृष्ठ पर मौजूद समस्याओं का सारांश यहां दिया गया है।' };
                            result = { action: 'summarize', targetId: null, responseText: responseText[lang] || responseText['en-US'] };
                        } else if (query.includes('profile') || query.includes('प्रोफ़ाइल')) {
                            responseText = { 'en-US': 'You can view your profile here.', 'hi-IN': 'आप अपनी प्रोफ़ाइल यहां देख सकते हैं।' };
                            result = { action: 'highlight', targetId: isDesktop() ? 'desktop-profile-link' : 'profile-nav-link', responseText: responseText[lang] || responseText['en-US'] };
                        } else if (query.includes('search') || query.includes('खोज')) {
                            responseText = { 'en-US': 'Taking you to the search page.', 'hi-IN': 'आपको खोज पृष्ठ पर ले जा रहा हूँ।' };
                            result = { action: 'navigate', targetId: isDesktop() ? 'desktop-search-link' : 'search-nav-link', responseText: responseText[lang] || responseText['en-US'] };
                        } else if (query.includes('filter') || query.includes('फ़िल्टर')) {
                            responseText = { 'en-US': 'Opening the filter panel.', 'hi-IN': 'फ़िल्टर पैनल खोल रहा हूँ।' };
                            result = { action: 'open_panel', targetId: 'filter', responseText: responseText[lang] || responseText['en-US'] };
                        } else if (query.includes('notification') || query.includes('अधिसूचना') || query.includes('नोटिफिकेशन')) {
                            responseText = { 'en-US': 'Showing your notifications.', 'hi-IN': 'आपकी सूचनाएं दिखा रहा हूँ।' };
                            result = { action: 'open_panel', targetId: 'notification', responseText: responseText[lang] || responseText['en-US'] };
                        }
                        return result;
                    };
                    const result = mockAI(text, recognition.lang);
                    processAIResponse(result);
                } catch (error) {
                    [aiWidgetDesktop, aiWidgetMobile].forEach(w => w.setStatus("Sorry, I had an issue.", true));
                    speak("Sorry, I am having trouble connecting right now.");
                }
            }
    
            function processAIResponse(response) {
                clearTimeout(aiTimeout);
                if (response.responseText) {
                    speak(response.responseText);
                    [aiWidgetDesktop, aiWidgetMobile].forEach(w => w.setStatus(response.responseText));
                }
                if (currentHighlight) currentHighlight.classList.remove('ai-highlight');
    
                if (response.action === 'highlight' && response.targetId) {
                    const element = document.getElementById(response.targetId);
                    if (element) {
                        if (isAiActive) [aiWidgetDesktop, aiWidgetMobile].forEach(w => w.deactivate());
                        element.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        element.classList.add('ai-highlight');
                        currentHighlight = element;
                        setTimeout(() => { if (currentHighlight) currentHighlight.classList.remove('ai-highlight'); }, 5000);
                    }
                } else if (response.action === 'navigate' && response.targetId) {
                    const element = document.getElementById(response.targetId);
                    if (element && element.href) window.location.href = element.href;
                } else if (response.action === 'redirect' && response.targetId) { // IMPROVEMENT: Added redirect action
                    setTimeout(() => { window.location.href = response.targetId; }, 1200); // Delay for user to hear response
                } else if (response.action === 'open_panel' && response.targetId) {
                    if (isAiActive) [aiWidgetDesktop, aiWidgetMobile].forEach(w => w.deactivate());
                    if (response.targetId === 'filter') openFilter();
                    else if (response.targetId === 'notification') openNotificationPanel();
                } else if (response.action === 'summarize') {
                    const summaryPoints = generatePageSummary();
                    displaySummary(summaryPoints);
                    aiTimeout = setTimeout(() => { if (isAiActive) [aiWidgetDesktop, aiWidgetMobile].forEach(w => w.deactivate()); }, 15000);
                } else {
                    aiTimeout = setTimeout(() => { if (isAiActive) [aiWidgetDesktop, aiWidgetMobile].forEach(w => w.deactivate()); }, 5000);
                }
            }
    
            function speak(text) {
                if (!('speechSynthesis' in window)) return;
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = getCurrentLanguage();
                utterance.onstart = () => { [aiWidgetDesktop, aiWidgetMobile].forEach(w => w.setState('speaking')); };
                utterance.onend = () => {
                    [aiWidgetDesktop, aiWidgetMobile].forEach(w => w.setState('idle'));
                    clearTimeout(aiTimeout);
                    aiTimeout = setTimeout(() => { if (isAiActive) [aiWidgetDesktop, aiWidgetMobile].forEach(w => w.deactivate()); }, 5000);
                };
                window.speechSynthesis.speak(utterance);
            }
    
            class AiWidget {
                constructor(element, isMobile = false) {
                    this.element = element;
                    this.isMobile = isMobile;
                    this.isActive = false;
    
                    this.originalIcon = this.element.querySelector('.original-icon');
                    if (this.originalIcon) this.originalIcon.style.transition = 'transform 0.3s ease, opacity 0.3s ease';
    
                    this.element.insertAdjacentHTML('beforeend', this.createHTML());
    
                    this.widgetInner = this.element.querySelector('.ai-widget-inner');
                    this.statusEl = this.element.querySelector('.ai-status');
                    this.logoIcon = this.element.querySelector('.ai-logo-icon');
                    this.micIcon = this.element.querySelector('.ai-mic-icon');
    
                    this.element.addEventListener('click', (e) => this.handleMainClick(e));
                    this.widgetInner.querySelector('.ai-icon-container').addEventListener('click', (e) => this.handleMicClick(e));
                }
    
                createHTML() {
                    const logoSize = this.isMobile ? 'w-5 h-5' : 'w-8 h-8';
                    const micSize = this.isMobile ? 'w-6 h-6' : 'w-8 h-8';
                    return `
                        <div class="ai-widget-inner">
                            <div class="ai-icon-container">
                                <svg class="${logoSize} text-white ai-logo-icon" viewBox="0 0 24 24" fill="currentColor"><path d="M12.0001 1.99219L3.45911 12.0002L12.0001 22.0082L20.5411 12.0002L12.0001 1.99219Z"/></svg>
                                <svg class="${micSize} text-white ai-mic-icon" viewBox="0 0 24 24" fill="none"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z" fill="currentColor"/><path d="M19 10v2a7 7 0 0 1-14 0v-2H3v2a9 9 0 0 0 8 8.94V24h2v-3.06A9 9 0 0 0 21 12v-2h-2z" fill="currentColor"/></svg>
                            </div>
                            <div class="ai-content">
                                <p class="ai-status text-sm text-white w-full text-left font-semibold"></p>
                            </div>
                        </div>
                    `;
                }
    
                handleMainClick(event) {
                    if (event.target.closest('.ai-icon-container')) {
                        return; // Let the mic click handler manage it
                    }
                    this.toggle(event);
                }
    
                handleMicClick(event) {
                    event.stopPropagation();
                    if (this.isActive) {
                        startListening(event);
                    } else {
                        const showInfo = !localStorage.getItem('setuAiInfoShown');
                        if (showInfo) {
                            this.showAiInfoModal();
                        } else {
                            this.activate();
                        }
                    }
                }
    
                toggle(event) {
                    event.stopPropagation();
                    const showInfo = !this.isActive && !localStorage.getItem('setuAiInfoShown');
                    if (showInfo) {
                        this.showAiInfoModal();
                        return;
                    }
                    this.isActive ? this.deactivate() : this.activate();
                }
    
                showAiInfoModal() {
                    UI.aiInfoModalOverlay.classList.remove('hidden');
                    setTimeout(() => {
                        UI.aiInfoModalOverlay.style.opacity = '1';
                        UI.aiInfoModal.classList.remove('scale-95', 'opacity-0');
                    }, 10);
    
                    const gotItHandler = () => {
                        localStorage.setItem('setuAiInfoShown', 'true');
                        UI.aiInfoModalOverlay.style.opacity = '0';
                        UI.aiInfoModal.classList.add('scale-95', 'opacity-0');
                        setTimeout(() => {
                            UI.aiInfoModalOverlay.classList.add('hidden');
                            this.activate();
                        }, 300);
                        UI.aiInfoGotItBtn.removeEventListener('click', gotItHandler);
                    };
                    UI.aiInfoGotItBtn.addEventListener('click', gotItHandler);
                }
    
                activate() {
                    if (navigator.vibrate) navigator.vibrate(50);
                    const animationPreference = localStorage.getItem('animationPreference');
                    this.element.classList.remove('modern-animation'); // Clear old animation class
                    if (animationPreference === 'modern') {
                        this.element.classList.add('modern-animation');
                    }
                    this.isActive = true; isAiActive = true;
                    this.element.classList.add('active');
                    if (this.isMobile) UI.mobileHeader.classList.add('ai-active');
                    this.setStatus('Tap the icon to speak.');
    
                    if (!sessionStorage.getItem('setuAiButtonClicked')) {
                        document.querySelectorAll('.ai-widget-container').forEach(el => el.classList.remove('setu-btn-animated'));
                        sessionStorage.setItem('setuAiButtonClicked', 'true');
                    }
                    setTimeout(() => startListening({ stopPropagation: () => { } }), 500);
                }
    
                deactivate() {
                    this.isActive = false; isAiActive = false;
                    this.element.classList.remove('active', 'expanded-vertically', 'modern-animation');
                    if (this.isMobile) UI.mobileHeader.classList.remove('ai-active');
                    if (recognition) recognition.stop();
    
                    const summaryBox = this.element.querySelector('#ai-summary-box');
                    if (summaryBox) {
                        summaryBox.classList.remove('visible');
                        setTimeout(() => summaryBox.remove(), 300);
                    }
                }
    
                setStatus(text, isError = false) {
                    this.statusEl.textContent = text;
                    this.statusEl.style.color = isError ? '#fee2e2' : '#ffffff';
    
                    // Add/remove class based on text length to expand the container
                    const characterLimit = 45; // Characters before expanding
                    if (this.isActive && text.length > characterLimit) {
                        this.element.classList.add('expanded-vertically');
                    } else {
                        this.element.classList.remove('expanded-vertically');
                    }
                }
    
                setState(state) {
                    this.element.classList.remove('listening', 'speaking');
                    this.logoIcon.classList.remove('spin');
                    this.micIcon.classList.remove('spin');
                    if (state === 'listening') {
                        this.element.classList.add('listening');
                        this.logoIcon.classList.add('spin');
                    } else if (state === 'speaking') {
                        this.element.classList.add('speaking');
                        this.micIcon.classList.add('spin');
                    }
                }
            } */

            // Initial setup
            setupTheme();

            if (!sessionStorage.getItem('setuIntroShown')) {
                // This is a placeholder for your intro animation logic if you bring it back
            }
            loadComplaints();
            setupTheme();
            setupLogoAnimation();
            restoreLanguageDisplay();
            setupScrollAnimations();
            renderFeed(complaints);


            // Event Listeners
            UI.homeNavLink.addEventListener('click', (e) => { e.preventDefault(); window.scrollTo({ top: 0, behavior: 'smooth' }); });
            UI.feedContainer.addEventListener('click', handleCardClick);
            document.body.addEventListener('click', handleInteractiveElements);
            UI.openFilterBtn.addEventListener('click', openFilter);
            if (UI.openFilterBtnDesktop) UI.openFilterBtnDesktop.addEventListener('click', openFilter);
            UI.closeFilterBtn.addEventListener('click', closeFilter);
            UI.filterBackdrop.addEventListener('click', closeFilter);
            UI.imageViewerClose.addEventListener('click', closeImageViewer);
            UI.imageViewerOverlay.addEventListener('click', (e) => { if (e.target === UI.imageViewerOverlay) closeImageViewer(); });
            UI.fullscreenImage.addEventListener('wheel', handleWheel, { passive: false });
            UI.fullscreenImage.addEventListener('pointerdown', handlePointerDown);
            window.addEventListener('pointermove', handlePointerMove);
            window.addEventListener('pointerup', handlePointerUp);
            document.addEventListener('click', (e) => {
                if (isAiActive && !e.target.closest('.ai-widget-container')) {
                    [aiWidgetDesktop, aiWidgetMobile].forEach(w => w.deactivate());
                }
            });
            /*          UI.notificationBtnMobile.addEventListener('click', openNotificationPanel);
                        if (UI.notificationBtnDesktop) UI.notificationBtnDesktop.addEventListener('click', openNotificationPanel);
                        UI.closeNotificationBtn.addEventListener('click', closeNotificationPanel);
                        UI.notificationBackdrop.addEventListener('click', closeNotificationPanel); */
        });
    </script>
    <script src="//translate.google.com/translate_a/element.js?cb=googleTranslateElementInit" async defer></script>
</body>

</html>